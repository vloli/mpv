name: Sync MPV, Protect event.c & Clean Workflows

on:
  schedule:
    - cron: '0 0 * * *' # 每天凌晨 0:00 自动运行
  workflow_dispatch:      # 允许手动点击按钮触发

# 核心权限设置
permissions:
  contents: write
  actions: write

jobs:
  sync-task:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and Fetch
        run: |
          git remote add upstream https://github.com/mpv-player/mpv.git
          git fetch upstream

      - name: Sync and Protect
        run: |
          # 1. 确保在 master 分支
          git checkout master

          # 2. 物理备份关键文件到临时目录
          mkdir -p /tmp/backup
          [ -f "input/event.c" ] && cp input/event.c /tmp/backup/event.c
          cp .github/workflows/sync_mpv.yml /tmp/backup/sync_mpv.yml

          # 3. 合并上游代码
          # 使用 -X ours 策略：如果官方也改了 event.c，优先保留你的逻辑
          echo "Merging upstream..."
          git merge upstream/master --no-edit -X ours || echo "Merge conflict handled"

          # 4. 彻底清理不需要的官方 Workflows
          # 使用 git rm 会让 Git 记录下“删除”这个动作
          if [ -d ".github/workflows" ]; then
            git rm -rf .github/workflows/*.yml || true
          fi

          # 5. 精准还原：放回你自己的脚本和修改过的代码
          mkdir -p .github/workflows
          cp /tmp/backup/sync_mpv.yml .github/workflows/sync_mpv.yml
          if [ -f "/tmp/backup/event.c" ]; then
            cp /tmp/backup/event.c input/event.c
          fi

          # 6. 提交所有更改
          # 这步会包含上游的更新和你对 workflow 的清理
          git add .github/workflows/sync_mpv.yml
          git add input/event.c
          git add . 

          if ! git diff-index --quiet HEAD; then
            echo "Changes detected, committing..."
            git commit -m "chore: sync upstream, protect event.c and keep only sync_mpv.yml"
            git push origin master
          else
            echo "No changes to commit. Everything is up to date."
          fi
